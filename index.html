<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  
  <title>Dopamine Runner: Gacha Shop ğŸ²</title>
  
  <style>
    @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

    :root{ --bg:#fde2ff; --panel: rgba(255,255,255,.95); --ink:#2a2a2a; --shadow: 0 4px 10px rgba(0,0,0,.1); --round: 20px; --ground-height: 40px; --accent: #6200ea; }
    * { box-sizing: border-box; }
    
    body{ margin:0; height: 100dvh; display:flex; justify-content: center; align-items: center; background: var(--bg); font-family: "Pretendard", sans-serif; color:var(--ink); overflow:hidden; touch-action: none; user-select: none; -webkit-user-select: none; transition: background 2s ease; }

    /* ë°°ê²½ í…Œë§ˆ */
    body.sunset { background: linear-gradient(to bottom, #e66465, #9198e5) !important; color: white; }
    body.night { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364) !important; color: white; }
    body.midnight { background: linear-gradient(to bottom, #232526, #414345) !important; color: white; }
    body.space { background: linear-gradient(to bottom, #2b1055, #7597de) !important; color: white; }
    body.aurora { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab) !important; background-size: 400% 400% !important; animation: gradientBG 10s ease infinite !important; color: white; }
    body.fever-mode { background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000) !important; background-size: 400%; animation: rainbowBg 0.5s linear infinite !important; color: white !important; }
    @keyframes rainbowBg { 0% {background-position: 0%;} 100% {background-position: 400%;} }
    @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

    .app{ width: 100%; height: 100%; position:relative; display: flex; flex-direction: column; }
    .top-container { position: relative; margin: 20px; z-index: 20; flex-shrink: 0; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:var(--panel); border-radius:var(--round); box-shadow: var(--shadow); font-weight: bold; color: #2a2a2a !important; }
    .score-box span{ background: white; padding: 5px 12px; border-radius: 15px; margin-left: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #333; font-weight: 900; }
    
    /* ğŸ’° ì½”ì¸ í‘œì‹œ UI */
    .coin-display { position: absolute; top: -10px; right: 10px; background: #FFD700; color: #333; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: translateY(-100%); z-index: 25; border: 2px solid #fff; }

    .fever-bar-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 8px; overflow: hidden; border: 2px solid rgba(255,255,255,0.5); }
    .fever-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #fbc02d, #ffeb3b); transition: width 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 0 10px #ffeb3b; }
    .fever-bar-fill.full { background: linear-gradient(90deg, #ff0000, #ffff00); animation: pulseBar 0.2s infinite; }
    @keyframes pulseBar { 0%{opacity:1;} 50%{opacity:0.7;} 100%{opacity:1;} }

    .stage{ position:relative; flex-grow: 1; width: 100%; border-radius: var(--round); box-shadow: var(--shadow); background: transparent; overflow:hidden; user-select:none; cursor: pointer; -webkit-tap-highlight-color: transparent; transform: translateZ(0); }
    .stage.shake { animation: shakeAnim 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    .stage.smash-shake { animation: smashShake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shakeAnim { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    @keyframes smashShake { 0% { transform: translate(0,0); } 25% { transform: translate(5px, 5px); } 50% { transform: translate(-5px, -5px); } 75% { transform: translate(5px, -5px); } 100% { transform: translate(0,0); } }

    .ground{ position: absolute; bottom:0; width: 100%; height: var(--ground-height); background: rgba(255,255,255,0.6); border-top: 3px solid rgba(255,255,255,0.8); transition: background 1.5s; }
    body.night .ground, body.space .ground, body.aurora .ground, body.midnight .ground, body.sunset .ground { background: rgba(255,255,255,0.15); border-top: 3px solid rgba(255,255,255,0.3); }

    .player { position: absolute; left: 50px; bottom: var(--ground-height); width: 90px; height: 90px; z-index: 10; transform-origin: center; will-change: transform, bottom; background: transparent; transition: transform 0.3s; display:flex; align-items:center; justify-content:center; font-size: 60px; /* ì´ëª¨ì§€ìš© */ }
    .player img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2)); transition: transform 0.1s; }
    .player.giant { transform: scale(1.5); filter: drop-shadow(0 0 15px gold); }
    
    @keyframes runWobble { 0% { transform: rotate(-3deg) translateY(0); } 25% { transform: rotate(0deg) translateY(-2px); } 50% { transform: rotate(3deg) translateY(0); } 75% { transform: rotate(0deg) translateY(-2px); } 100% { transform: rotate(-3deg) translateY(0); } }
    .player.running img, .player.running.emoji-char { animation: runWobble 0.3s infinite linear; }
    .spin img, .spin.emoji-char { animation: spinPlayer 0.5s ease-in-out; }
    @keyframes spinPlayer { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes knockback { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 100% { transform: scale(0.8) rotate(720deg) translate(200px, -200px); opacity: 0; } }
    .player.dead { animation: knockback 0.8s forwards ease-out; }

    .trail { position: absolute; width: 90px; height: 90px; opacity: 0.6; pointer-events: none; z-index: 5; filter: grayscale(1) blur(1px); transition: opacity 0.3s, transform 0.3s; display:flex; align-items:center; justify-content:center; font-size: 60px;}
    .trail img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }

    .dust { position: absolute; width: 30px; height: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 50%; z-index: 5; animation: dustAnim 0.4s forwards; }
    @keyframes dustAnim { 0% { transform: scale(0.5); opacity: 0.8; } 100% { transform: scale(1.5) translateY(-10px); opacity: 0; } }
    .float-text { position: absolute; font-weight: 900; color: #ffeb3b; font-size: 24px; z-index: 50; pointer-events: none; text-shadow: 2px 2px 0 #000; animation: floatUp 0.8s forwards; }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }

    .obstacle{ position:absolute; width:50px; height:50px; font-size:40px; display:flex; align-items:center; justify-content:center; will-change: left; transition: filter 0.5s; }
    .obstacle.bird { animation: fly 0.6s infinite alternate ease-in-out; font-size: 45px; }
    @keyframes fly { from { transform: translateY(0); } to { transform: translateY(-10px); } }
    .obstacle.high-danger { filter: hue-rotate(270deg); font-size: 50px; }
    .obstacle.tall { font-size: 70px; height: 90px; align-items: flex-end; }
    body.night .obstacle, body.space .obstacle, body.aurora .obstacle { filter: brightness(1.2); }
    .obstacle.smashed { transition: none; animation: smashAnim 0.5s forwards ease-out; z-index: 20; }
    @keyframes smashAnim { 0% { transform: scale(1); } 30% { transform: scale(1.3) rotate(45deg); filter: brightness(5); } 100% { transform: scale(0) rotate(180deg) translate(50px, -150px); opacity: 0; } }

    .item-star { position: absolute; width: 40px; height: 40px; font-size: 35px; display: flex; align-items: center; justify-content: center; z-index: 9; animation: spinStar 2s infinite linear; will-change: left; }
    @keyframes spinStar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .milestone-text { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; font-weight: bold; color: #FFD700; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 50; animation: popFade 1.5s forwards; }
    @keyframes popFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 30% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -100%) scale(1.5); opacity: 0; } }

    .overlay{ position:absolute; inset:0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display:flex; justify-content:center; align-items:center; z-index: 100; transition: opacity 0.2s; }
    .panel{ background: white; padding: 25px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align:center; width: 90%; max-width: 450px; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-height: 85vh; display: flex; flex-direction: column; }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .options-group { margin-bottom: 15px; text-align: left; }
    .label { font-size: 13px; font-weight: bold; color: #888; margin-bottom: 8px; display: block; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { padding: 10px 14px; border: 2px solid #eee; border-radius: 20px; cursor: pointer; font-weight: bold; background: #fafafa; transition: all 0.2s; display: flex; align-items: center; gap: 6px; font-size: 14px; color: #aaa; filter: grayscale(1); } /* ë¯¸ë³´ìœ  íë¦¬ê²Œ */
    .chip.owned { color: #333; filter: grayscale(0); border-color: #ddd; } /* ë³´ìœ í•¨ */
    .chip:hover { transform: translateY(-2px); border-color: #ddd; }
    .chip.selected { border-color: #333; background: #333; color: white !important; box-shadow: 0 5px 15px rgba(0,0,0,0.2); filter: none; }
    
    /* ì¹© ìŠ¤íƒ€ì¼ (ì ê¹€/í•´ê¸ˆ) */
    .chip.locked { opacity: 0.5; pointer-events: none; background: #eee; }
    .chip.hidden-unlocked { border-color: gold; background: #fffbe6; color: #d48806; animation: glow 2s infinite; }
    .chip.hidden-unlocked.selected { background: gold; color: white; border-color: orange; }
    .chip.dragon-unlocked { border-color: #9775fa; background: #f3f0ff; color: #5f3dc4; animation: glowPurple 2s infinite; }
    .chip.dragon-unlocked.selected { background: #7950f2; color: white; border-color: #5f3dc4; }
    .chip.bg-unlocked { border-color: #00b894; background: #f0fffa; color: #006266; filter: none; opacity: 1;} /* ë°°ê²½ì€ í•­ìƒ í™œì„± */
    .chip.bg-unlocked.selected { background: #00b894; color: white; }
    .chip.aurora-unlocked { background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 5s ease infinite; color: white; border: none; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    .chip.aurora-unlocked.selected { transform: scale(1.1); box-shadow: 0 0 15px rgba(0,0,0,0.3); border: 3px solid white; }
    
    @keyframes glow { 0%,100%{box-shadow: 0 0 5px gold;} 50%{box-shadow: 0 0 15px orange;} }
    @keyframes glowPurple { 0%,100%{box-shadow: 0 0 5px #b197fc;} 50%{box-shadow: 0 0 15px #7950f2;} }

    .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    button { border: none; padding: 12px 20px; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
    button:active { transform: scale(0.95); }
    .btn-primary { background: #333; color: white; flex: 1; min-width: 120px; }
    .btn-secondary { background: #f0f0f0; color: #333; flex: 1; min-width: 100px; }
    .btn-share { background: #4a90e2; color: white; flex: 1; min-width: 140px; }
    .btn-rank { background: var(--accent); color: white; flex: 1; min-width: 100px; }
    .btn-shop { background: #FFD700; color: #333; flex: 1; min-width: 120px; border: 2px solid #e6c200; }
    
    .support-group { margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .btn-support { font-size: 13px; padding: 10px 15px; flex: 1 1 auto; display: flex; align-items: center; justify-content: center; gap: 6px; transition: transform 0.1s; }
    .btn-ctee { background: #FFD700; color: #333; border: 1px solid #e6c200; }
    .btn-bmc { background: #FFDD00; color: #333; border: 1px solid #e6c700; }

    .hidden { display: none !important; }
    .result-box { background: #f9f9f9; border-radius: 15px; padding: 15px; margin: 10px 0; text-align: left; border: 2px solid #eee; overflow-y: auto; }
    .result-rank { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .fortune-area { margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px; text-align: center; }
    .locked-fortune { color: #999; font-size: 14px; font-style: italic; }
    .btn-fortune { background: linear-gradient(45deg, #ff9a9e, #fad0c4); color: white; width: 100%; animation: pulse 1.5s infinite; border: none; }
    .fortune-msg { font-size: 15px; color: #d48806; font-weight: bold; animation: popUp 0.5s; line-height: 1.4; word-break: keep-all;}
    .sound-toggle { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; z-index: 30; background: rgba(255,255,255,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

    .rank-form { display: flex; gap: 5px; margin-top: 10px; flex-shrink: 0; }
    .rank-input { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-weight: bold; }
    .btn-submit { background: var(--accent); color: white; flex: 0 0 60px; }
    .rank-list { margin-top: 10px; flex: 1; min-height: 0; overflow-y: auto; text-align: left; font-size: 13px; background: #fff; border: 1px solid #eee; padding: 5px; border-radius: 10px; }
    .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0; color: #333 !important; }
    .rank-item:last-child { border-bottom: none; }
    .rank-name { font-weight: bold; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
    .rank-score { font-weight: bold; color: var(--accent); white-space: nowrap; }

    /* ğŸ ìƒì  UI */
    .shop-area { text-align: center; margin-top: 10px; }
    .shop-box { 
        width: 120px; height: 120px; margin: 0 auto; 
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" x="10" font-size="80">ğŸ</text></svg>') no-repeat center; 
        background-size: contain; 
        cursor: pointer; transition: transform 0.1s;
    }
    .shop-box:active { transform: scale(0.95); }
    .shop-box.shaking { animation: boxShake 0.5s infinite; }
    @keyframes boxShake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
    .gacha-msg { font-size: 18px; font-weight: bold; color: var(--accent); min-height: 24px; margin-bottom: 10px; }
  </style>
</head>
<body>

<div class="app">
  <div class="top-container">
    <div class="topbar">
      <div>ğŸƒ Dopamine Runner</div>
      <div class="score-box">
        ìµœê³  <span id="bestScore">0</span>
        ì ìˆ˜ <span id="currentScore">0</span>
      </div>
    </div>
    <div class="coin-display">ğŸ’° <span id="userCoins">0</span></div>
    <div class="fever-bar-bg">
        <div id="feverBar" class="fever-bar-fill"></div>
    </div>
  </div>

  <div class="stage" id="gameStage">
    <div class="cloud-decor" style="position:absolute; top:20px; left:10%; font-size:30px; opacity:0.8; transition:opacity 1s;">â˜ï¸</div>
    <div class="cloud-decor" style="position:absolute; top:50px; left:60%; font-size:40px; opacity:0.6; transition:opacity 1s;">â˜ï¸</div>
    <div class="player" id="player"></div>
    <div class="ground"></div>
    <div class="sound-toggle" id="soundBtn" title="ë°°ê²½ìŒì•…">ğŸ”Š</div>

    <div class="overlay" id="startOverlay">
      <div class="panel">
        <h1>ê²Œì„ ì„¤ì •</h1>
        <p>ë³´ìœ  ì½”ì¸: ğŸ’° <span id="startCoins">0</span></p>
        
        <div class="options-group">
          <span class="label">ìºë¦­í„° (ê¸°ë³¸ / ê°€ì±  / ë­í‚¹)</span>
          <div class="chips" id="charOptions">
            </div>
        </div>
        
        <div class="options-group">
          <span class="label">ë°°ê²½ í…Œë§ˆ (ì ìˆ˜ë³„ í•´ê¸ˆ)</span>
          <div class="chips" id="bgOptions">
            <div class="chip selected" onclick="selectBg('basic', '#fde2ff', this)">ğŸŒ¸ ë¶„í™</div>
            <div class="chip" onclick="selectBg('basic', '#dff3ff', this)">â˜ï¸ í•˜ëŠ˜</div>
            <div class="chip" onclick="selectBg('basic', '#e6ffd9', this)">ğŸŒ¿ ì—°ë‘</div>
          </div>
        </div>
        <div class="btn-group">
            <button class="btn-shop" onclick="openShop()">ğŸª ìƒì </button>
            <button class="btn-primary" onclick="startGame()">ê²Œì„ ì‹œì‘ ğŸµ</button>
        </div>
      </div>
    </div>

    <div class="overlay hidden" id="shopOverlay">
        <div class="panel">
            <h2>ğŸª ìŠ¤í‚¨ ìƒì </h2>
            <p>ì½”ì¸ìœ¼ë¡œ ëœë¤ ìŠ¤í‚¨ì„ ë½‘ì•„ë³´ì„¸ìš”!<br>(ì¤‘ë³µ ì‹œ 300ì½”ì¸ í™˜ê¸‰)</p>
            <div class="label">ë³´ìœ  ì½”ì¸: ğŸ’° <span id="shopCoins">0</span></div>
            
            <div class="shop-area">
                <div id="gachaBox" class="shop-box" onclick="drawGacha()"></div>
                <div id="gachaResult" class="gacha-msg"></div>
                <button class="btn-primary" onclick="drawGacha()">ğŸ² 500ì½”ì¸ ë½‘ê¸°</button>
            </div>

            <div style="margin-top:15px;">
                <button class="btn-secondary" onclick="closeShop()">â†©ï¸ ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <div class="overlay hidden" id="gameOverOverlay">
      <div class="panel">
        <h2 style="font-size:40px; margin-bottom:5px;">ğŸ˜µâ€ğŸ’«</h2>
        <h1>ê²Œì„ ì˜¤ë²„!</h1>
        <p style="font-size:16px; color:#333; font-weight:bold; margin-bottom:10px;">
          ìµœì¢… ì ìˆ˜: <span id="finalScore">0</span>
        </p>
        <div class="result-box">
            <div class="result-rank" id="rankText">ğŸ† ë“±ê¸‰: ì‹ ìƒì•„</div>
            <div class="fortune-area" id="fortuneContainer"></div>
        </div>
        <div id="unlockMsg" class="hidden" style="color:#d48806; font-weight:bold; margin-bottom:15px; background:#fffbe6; padding:10px; border-radius:10px;"></div>
        <div class="btn-group">
          <button class="btn-secondary" onclick="backToSettings()">âš™ï¸ ì„¤ì •</button>
          <button class="btn-primary" onclick="restartGame()">ğŸ”„ ì¬ì‹œì‘</button>
        </div>
        <div class="btn-group">
            <button class="btn-share" id="shareBtn" onclick="shareScore()">ğŸ”— ê³µìœ </button>
            <button class="btn-rank" onclick="openRanking()">ğŸ† ë­í‚¹ ë³´ê¸°</button>
        </div>
        <div class="support-group">
          <button class="btn-support btn-ctee" onclick="window.open('https://ctee.kr/place/byh3071', '_blank')">â˜• êµ­ë‚´ í›„ì› (í¬í‹°)</button>
          <button class="btn-support btn-bmc" onclick="window.open('https://buymeacoffee.com/byh3071x?status=1', '_blank')">ğŸŒ Global (BMC)</button>
        </div>
      </div>
    </div>

    <div class="overlay hidden" id="rankingOverlay">
        <div class="panel" style="display:flex; flex-direction:column; height:85vh;">
            <h2 style="flex-shrink:0;">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            <div class="label" style="text-align:left; margin-top:10px; flex-shrink:0;">ë‚´ ê¸°ë¡ ë“±ë¡í•˜ê¸°</div>
            <div class="rank-form">
                <input type="text" id="nicknameInput" class="rank-input" placeholder="ë‹‰ë„¤ì„ (ë¯¸ì…ë ¥ ì‹œ ìµëª…)" maxlength="8">
                <button class="btn-submit" onclick="submitRank()">ë“±ë¡</button>
            </div>
            <div id="rankList" class="rank-list">
                <div style="text-align:center; color:#999; padding:20px;">ë¡œë”© ì¤‘...</div>
            </div>
            <div style="margin-top:15px; flex-shrink:0;">
                <button class="btn-primary" onclick="closeRanking()">â†©ï¸ ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
  // âš ï¸ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL í•„ìˆ˜! (ë³¸ì¸ì˜ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œë¡œ í™•ì¸í•´ì£¼ì„¸ìš”)
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4oxlHh4I9KvBj1rlgTdDCxFDrpwMugkfFzNZOMIG1ZzakJb93QD2KVdnmY2LuqOQZ3Q/exec"; 

  const player = document.getElementById('player');
  const stage = document.getElementById('gameStage');
  const startOverlay = document.getElementById('startOverlay');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const rankingOverlay = document.getElementById('rankingOverlay');
  const shopOverlay = document.getElementById('shopOverlay');
  
  const scoreEl = document.getElementById('currentScore');
  const finalScoreEl = document.getElementById('finalScore');
  const bestScoreEl = document.getElementById('bestScore');
  const charOptions = document.getElementById('charOptions');
  const bgOptions = document.getElementById('bgOptions');
  const unlockMsg = document.getElementById('unlockMsg');
  const soundBtn = document.getElementById('soundBtn');
  const shareBtn = document.getElementById('shareBtn');
  const rankText = document.getElementById('rankText');
  const fortuneContainer = document.getElementById('fortuneContainer');
  const feverBar = document.getElementById('feverBar');
  const rankList = document.getElementById('rankList');
  const nicknameInput = document.getElementById('nicknameInput');
  const userCoinsEl = document.getElementById('userCoins');
  const startCoinsEl = document.getElementById('startCoins');
  const shopCoinsEl = document.getElementById('shopCoins');
  const gachaBox = document.getElementById('gachaBox');
  const gachaResult = document.getElementById('gachaResult');

  // --- ìŠ¤í‚¨ ë°ì´í„° & ìƒíƒœ ê´€ë¦¬ ---
  let myChar = { type: 'image', val: 'dog.png' }; // í˜„ì¬ ì„ íƒëœ ìºë¦­í„°
  let myBg = "#fde2ff";
  let selectedBgType = 'basic'; 
  let isSpecialTheme = false; 

  // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  let best = Number(localStorage.getItem('runnerBest') || 0);
  let totalCoins = Number(localStorage.getItem('runnerCoins') || 0);
  // ì†Œìœ  ìŠ¤í‚¨ ëª©ë¡ (ê¸°ë³¸ dogëŠ” í¬í•¨)
  let ownedSkins = JSON.parse(localStorage.getItem('runnerSkins') || '["dog.png"]');

  // ì „ì²´ ìŠ¤í‚¨ ëª©ë¡ ì •ì˜
  const SKIN_DB = [
      { id: 'dog.png', name: 'ğŸ¶ ê°•ì•„ì§€', type: 'image', obtain: 'default' },
      { id: 'cat.png', name: 'ğŸ± ê³ ì–‘ì´', type: 'image', obtain: 'gacha' },
      { id: 'rabbit.png', name: 'ğŸ° í† ë¼', type: 'image', obtain: 'gacha' },
      { id: 'ğŸ¼', name: 'ğŸ¼ íŒë‹¤', type: 'emoji', obtain: 'gacha' },
      { id: 'ğŸ‘½', name: 'ğŸ‘½ ì™¸ê³„ì¸', type: 'emoji', obtain: 'gacha' },
      { id: 'ğŸ¦„', name: 'ğŸ¦„ ìœ ë‹ˆì½˜', type: 'emoji', obtain: 'gacha' },
      { id: 'tiger.png', name: 'ğŸ¯ í˜¸ë‘ì´', type: 'image', obtain: 'score', req: 1000 },
      { id: 'dragon.png', name: 'ğŸ² ìš©', type: 'image', obtain: 'score', req: 2000 }
  ];

  let isRunning = false;
  let score = 0;
  let animationId;
  let frameCount = 0;
  let gameSpeed = 7.5; 
  const maxSpeed = 25; 
  const acceleration = 0.0015; 
  
  let feverGauge = 0;
  let isFever = false;
  let originalSpeed = 0;
  let playerY = 0; 
  let velocityY = 0;
  const gravity = 0.8;
  const jumpPower = 14;
  let jumpCount = 0; 
  const maxJumps = 2; 
  const GROUND_HEIGHT = 40; 

  let obstacles = [];
  let items = []; 
  let trails = []; 

  // í•´ê¸ˆ ì ìˆ˜ ìƒìˆ˜ ì •ì˜ (ì¶”ê°€ë¨)
  const UNLOCK_SCORE_TIGER = 1000;
  const UNLOCK_SCORE_DRAGON = 2000;
  
  const BG_UNLOCK_SUNSET = 1000;
  const BG_UNLOCK_MIDNIGHT = 1500;
  const BG_UNLOCK_SPACE = 2000;
  const BG_UNLOCK_AURORA = 2500;

  let cooldownTimer = 0; 

  // ì´ˆê¸°í™”
  bestScoreEl.innerText = best;
  updateCoinUI();
  renderCharOptions();
  updatePlayerImage();
  checkHiddenUnlock(); 

  // --- ìœ í‹¸ë¦¬í‹° ---
  function updateCoinUI() {
      userCoinsEl.innerText = totalCoins;
      startCoinsEl.innerText = totalCoins;
      shopCoinsEl.innerText = totalCoins;
      localStorage.setItem('runnerCoins', totalCoins);
  }

  function updatePlayerImage() { 
      if (myChar.type === 'image') {
          player.innerHTML = `<img src="${myChar.val}" alt="Char">`;
          player.classList.remove('emoji-char');
      } else {
          player.innerHTML = myChar.val;
          player.classList.add('emoji-char');
      }
  }

  // --- ìƒì  & ê°€ì±  ì‹œìŠ¤í…œ ---
  function openShop() {
      startOverlay.classList.add('hidden');
      shopOverlay.classList.remove('hidden');
      gachaResult.innerText = "";
      gachaBox.classList.remove('shaking');
  }
  function closeShop() {
      shopOverlay.classList.add('hidden');
      startOverlay.classList.remove('hidden');
      renderCharOptions(); // ìƒˆë¡œ ì–»ì€ ìŠ¤í‚¨ ë°˜ì˜
  }
  
  function drawGacha() {
      const COST = 500;
      if (totalCoins < COST) {
          alert("ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ì—´ì‹¬íˆ ë‹¬ë ¤ì„œ ëª¨ì•„ì˜¤ì„¸ìš”! ğŸƒâ€â™‚ï¸");
          return;
      }
      
      // ì½”ì¸ ì°¨ê°
      totalCoins -= COST;
      updateCoinUI();
      
      // ì• ë‹ˆë©”ì´ì…˜
      gachaBox.classList.add('shaking');
      gachaResult.innerText = "ë‘ê·¼ë‘ê·¼...";
      playSound('milestone'); // íš¨ê³¼ìŒ ì¬í™œìš©

      setTimeout(() => {
          gachaBox.classList.remove('shaking');
          // ê°€ì±  ë¡œì§: obtainì´ 'gacha'ì¸ ì• ë“¤ ì¤‘ì—ì„œ ëœë¤
          const gachaPool = SKIN_DB.filter(s => s.obtain === 'gacha');
          const picked = gachaPool[Math.floor(Math.random() * gachaPool.length)];
          
          let msg = "";
          if (ownedSkins.includes(picked.id)) {
              // ì¤‘ë³µ -> í™˜ê¸‰
              totalCoins += 300;
              updateCoinUI();
              msg = `ğŸ’¥ ì¤‘ë³µ! [${picked.name}] (300ì½”ì¸ ëŒë ¤ë°›ìŒ)`;
          } else {
              // ë‹¹ì²¨ -> ì €ì¥
              ownedSkins.push(picked.id);
              localStorage.setItem('runnerSkins', JSON.stringify(ownedSkins));
              msg = `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! [${picked.name}] íšë“!`;
              playSound('coin');
          }
          gachaResult.innerText = msg;
      }, 1000);
  }

  // --- ìºë¦­í„° ì„ íƒ UI ë Œë”ë§ ---
  function renderCharOptions() {
      charOptions.innerHTML = "";
      SKIN_DB.forEach(skin => {
          const isOwned = ownedSkins.includes(skin.id) || (skin.obtain === 'score' && best >= skin.req);
          const isSelected = myChar.val === skin.id;
          
          const el = document.createElement('div');
          el.className = `chip ${isOwned ? 'owned' : ''} ${isSelected ? 'selected' : ''}`;
          
          // ì ìˆ˜ í•´ê¸ˆí˜• ì²˜ë¦¬
          if (skin.obtain === 'score' && !isOwned) {
              el.classList.add(skin.id.includes('dragon') ? 'dragon-unlocked' : 'hidden-unlocked');
              el.classList.add('locked');
              el.innerText = `ğŸ”’ ${skin.req}ì `;
          } else {
              el.innerText = skin.name;
              if (isOwned) {
                  el.onclick = () => selectChar(skin.id, skin.type);
              }
          }
          charOptions.appendChild(el);
      });
  }

  function selectChar(id, type) {
      myChar = { type: type, val: id };
      renderCharOptions(); // ì„ íƒ ìƒíƒœ ê°±ì‹ 
      updatePlayerImage();
  }

  // ... (ì´í•˜ ì˜¤ë””ì˜¤, ê²Œì„ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë˜ ìŠ¤ì½”ì–´ -> ì½”ì¸ ì €ì¥ ë¡œì§ ì¶”ê°€) ...

  let audioCtx = null;
  let isMuted = false;
  function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
  function playBGM() {
    if (isMuted || !audioCtx) return; stopBGM(); 
    const notes = [392, 392, 440, 392, 523, 493, 392, 392, 440, 392, 587, 523]; 
    let time = audioCtx.currentTime;
    notes.forEach((freq, index) => createOscillator(freq, time + index * 0.4, 0.2, 'square'));
    window.bgmInterval = setInterval(() => {
       if(!isRunning || isMuted) { clearInterval(window.bgmInterval); return; }
       let t = audioCtx.currentTime;
       notes.forEach((freq, index) => createOscillator(freq, t + index * 0.4, 0.2, 'square'));
    }, notes.length * 400);
  }
  function createOscillator(freq, startTime, duration, type = 'square') {
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    const volume = type === 'sawtooth' ? 0.05 : 0.03; 
    gain.gain.setValueAtTime(volume, startTime); gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime); osc.stop(startTime + duration);
  }
  function playSound(type) {
      if(!audioCtx || isMuted) return;
      if(type === 'coin') { createOscillator(880, audioCtx.currentTime, 0.1, 'sine'); createOscillator(1760, audioCtx.currentTime + 0.1, 0.2, 'sine'); }
      else if(type === 'milestone') { createOscillator(523, audioCtx.currentTime, 0.2, 'triangle'); createOscillator(659, audioCtx.currentTime + 0.1, 0.2, 'triangle'); createOscillator(784, audioCtx.currentTime + 0.2, 0.4, 'triangle'); }
      else if(type === 'smash') { createOscillator(150, audioCtx.currentTime, 0.1, 'sawtooth'); createOscillator(100, audioCtx.currentTime + 0.05, 0.2, 'square'); }
  }
  function playCrunch() {
    if (!audioCtx || isMuted) return;
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.1); 
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15); 
    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.15);
  }
  function stopBGM() { if (window.bgmInterval) clearInterval(window.bgmInterval); }
  soundBtn.addEventListener('click', (e) => { e.stopPropagation(); isMuted = !isMuted; soundBtn.innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š"; if(isMuted) stopBGM(); else if(isRunning) playBGM(); });

  function selectBg(type, color, element) {
    myBg = color; selectedBgType = type;
    if (type !== 'basic') isSpecialTheme = true; else isSpecialTheme = false;
    document.querySelectorAll('#bgOptions .chip').forEach(opt => opt.classList.remove('selected'));
    element.classList.add('selected');
    document.body.className = ''; 
    if(type !== 'basic') document.body.classList.add(type);
    else document.documentElement.style.setProperty('--bg', myBg);
  }
  function checkHiddenUnlock() {
    if (best >= BG_UNLOCK_SUNSET && !document.getElementById('bgSunset')) {
        const chip = document.createElement('div'); chip.id = 'bgSunset'; chip.className = 'chip bg-unlocked';
        chip.innerHTML = 'ğŸ”¥ ë…¸ì„'; chip.onclick = function() { selectBg('sunset', '#9198e5', this); };
        bgOptions.appendChild(chip);
    }
    if (best >= BG_UNLOCK_MIDNIGHT && !document.getElementById('bgMidnight')) {
        const chip = document.createElement('div'); chip.id = 'bgMidnight'; chip.className = 'chip bg-unlocked';
        chip.innerHTML = 'ğŸŒƒ ì‹¬í•´'; chip.onclick = function() { selectBg('midnight', '#232526', this); };
        bgOptions.appendChild(chip);
    }
    if (best >= BG_UNLOCK_SPACE && !document.getElementById('bgSpace')) {
        const chip = document.createElement('div'); chip.id = 'bgSpace'; chip.className = 'chip bg-unlocked';
        chip.innerHTML = 'ğŸš€ ìš°ì£¼'; chip.onclick = function() { selectBg('space', '#2b1055', this); };
        bgOptions.appendChild(chip);
    }
    if (best >= BG_UNLOCK_AURORA && !document.getElementById('bgAurora')) {
        const chip = document.createElement('div'); chip.id = 'bgAurora'; chip.className = 'chip aurora-unlocked';
        chip.innerHTML = 'ğŸŒˆ ì˜¤ë¡œë¼'; chip.onclick = function() { selectBg('aurora', '#000000', this); };
        bgOptions.appendChild(chip);
    }
    renderCharOptions(); // ê°±ì‹ 
  }
  function getRank(s) {
    if(s < 100) return "ğŸ¥š ê±·ê¸°ë„ í˜ë“  ì‹ ìƒì•„";
    if(s < 500) return "ğŸ¢ ë™ë„¤ ë§ˆì‹¤ ë‚˜ì˜¨ ê±°ë¶ì´";
    if(s < 1000) return "ğŸ• ì‚°ì±… ë‚˜ì˜¨ ê°•ì•„ì§€";
    if(s < 2000) return "ğŸ… êµ­ê°€ëŒ€í‘œê¸‰ í”¼ì§€ì»¬";
    if(s < 3000) return "ğŸ”¥ ì¤‘ë ¥ì„ ê±°ìŠ¤ë¥´ëŠ” ì";
    if(s < 4000) return "ğŸš€ ëŒ€ê¸°ê¶Œ ëŒíŒŒ! ìš°ì£¼ì¸";
    if(s < 5000) return "ğŸ‘½ ì§€êµ¬ ì •ë³µí•˜ëŸ¬ ì˜¨ ì™¸ê³„ì¸";
    return "ğŸ‘‘ ì‚´ì•„ìˆëŠ” ì „ì„¤ (GOD)";
  }
  window.openFortune = function() {
    initAudio(); playCrunch();
    const fortunes = {
        bad: ["â›ˆï¸ [í‰] ìƒˆë˜¥ ë§ì„ í™•ë¥  99%...", "â›ˆï¸ [í‰] ì§€ê°‘ ë‘ê³  ë‚˜ì˜¬ ìˆ˜ ìˆìŒ.", "â›ˆï¸ [í‰] ì´ì–´í° í•œìª½ ê³ ì¥ë‚¨.", "â›ˆï¸ [í‰] ë°œëª© ì¡°ì‹¬í•˜ì„¸ìš”."],
        normal: ["â˜ï¸ [ë³´í†µ] ê·¸ëƒ¥ ê·¸ëŸ° í•˜ë£¨.", "â˜ï¸ [ë³´í†µ] ì ì‹¬ ë©”ë‰´ ê³ ë¯¼í•˜ë‹¤ ì‹œê°„ ë‹¤ ê°.", "â˜ï¸ [ë³´í†µ] ì¡¸ë¦° í•˜ë£¨.", "â˜ï¸ [ë³´í†µ] ë¬´ì†Œì‹ì´ í¬ì†Œì‹."],
        small: ["ğŸ€ [ì†Œê¸¸] ë²„ìŠ¤ ë°”ë¡œ ì˜´!", "ğŸ€ [ì†Œê¸¸] ì£¼ë¨¸ë‹ˆì—ì„œ ì²œì› ë°œê²¬.", "ğŸ€ [ì†Œê¸¸] ì‹ í˜¸ë“± íŒŒë€ë¶ˆ!", "ğŸ€ [ì†Œê¸¸] í¸ì˜ì  1+1 í–‰ì‚¬."],
        great: ["ğŸŒ [ëŒ€ê¸¸] ìˆ¨ë§Œ ì‰¬ì–´ë„ ì˜ í’€ë¦¼!", "ğŸŒ [ëŒ€ê¸¸] ë¡œë˜ 5ì²œì› ë‹¹ì²¨?", "ğŸŒ [ëŒ€ê¸¸] ì˜¤ëŠ˜ ì£¼ì¸ê³µì€ ë‹¹ì‹ !", "ğŸŒ [ëŒ€ê¸¸] ê·€ì¸ì„ ë§Œë‚  ìš´ì„¸."],
        love: ["ğŸ’˜ [ì—°ì• ] ì¸ë‚¨/ë…€ ì—°ë½ ì˜´.", "ğŸ’˜ [ì—°ì• ] ì´ìƒí˜•ê³¼ ëˆˆ ë§ˆì£¼ì¹¨.", "ğŸ’˜ [ì—°ì• ] ë§¤ë ¥ í­ë°œ.", "ğŸ’” [ì—°ì• /í‰] ì „ ì• ì¸ ì†Œì‹ ë¬´ì‹œí•˜ì„¸ìš”."],
        money: ["ğŸ’° [ê¸ˆì „/ëŒ€ë°•] ê½ëˆ ìƒê¸¸ ìš´ì„¸!", "ğŸ’° [ê¸ˆì „/ì£¼ì˜] ì¶©ë™êµ¬ë§¤ ì¡°ì‹¬.", "ğŸ’° [ê¸ˆì „] ë¹Œë ¤ì¤€ ëˆ ë°›ìŒ.", "ğŸ’¸ [ê¸ˆì „/í‰] íƒì‹œë¹„ ì•„ë¼ì„¸ìš”."]
    };
    const rand = Math.random();
    let msgList = [];
    if (rand < 0.05) msgList = fortunes.bad; else if (rand < 0.25) msgList = fortunes.normal; else if (rand < 0.50) msgList = fortunes.small; else if (rand < 0.80) msgList = fortunes.great; else if (rand < 0.90) msgList = fortunes.love; else msgList = fortunes.money;
    const msg = msgList[Math.floor(Math.random() * msgList.length)];
    fortuneContainer.innerHTML = `<div class="fortune-msg">${msg}</div>`;
  };
  function shareScore() {
    const rank = getRank(score);
    const text = `ğŸƒ Dopamine Runner\n[ê¸°ë¡] ${Math.floor(score)}ì \n[ë“±ê¸‰] ${rank}\n\në„ì „í•´ë³´ì„¸ìš”! ğŸ‘‡\nğŸ”— ${window.location.href}`;
    if (navigator.share) { navigator.share({ title: 'Dopamine Runner', text: text, url: window.location.href }).catch(console.error); }
    else { navigator.clipboard.writeText(text).then(() => { const t = shareBtn.innerText; shareBtn.innerText = "âœ… ë³µì‚¬ ì™„ë£Œ!"; setTimeout(() => { shareBtn.innerText = t; }, 2000); }).catch(err => alert("ë³µì‚¬ ì‹¤íŒ¨ ã… ã… ")); }
  }

  function openRanking() {
      gameOverOverlay.classList.add('hidden');
      rankingOverlay.classList.remove('hidden');
      loadRank(); 
  }
  function closeRanking() {
      rankingOverlay.classList.add('hidden');
      gameOverOverlay.classList.remove('hidden');
  }
  function submitRank() {
      let name = nicknameInput.value.trim();
      if (!name) name = "ìµëª…"; 
      const final = Math.floor(score);
      if (SCRIPT_URL.includes("ë¶™ì—¬ë„£ìœ¼ì„¸ìš”")) return alert("ë­í‚¹ ì„œë²„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      const btn = document.querySelector('.btn-submit');
      btn.disabled = true; btn.innerText = "...";
      fetch(SCRIPT_URL, {
          method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name, score: final })
      }).then(() => {
          alert("ë­í‚¹ ë“±ë¡ ì™„ë£Œ!"); nicknameInput.value = ""; btn.disabled = false; btn.innerText = "ë“±ë¡"; loadRank();
      }).catch(err => { alert("ì „ì†¡ ì‹¤íŒ¨: " + err); btn.disabled = false; btn.innerText = "ë“±ë¡"; });
  }
  function loadRank() {
      rankList.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">ë¡œë”© ì¤‘...</div>';
      if (SCRIPT_URL.includes("ë¶™ì—¬ë„£ìœ¼ì„¸ìš”")) return rankList.innerHTML = "<div>ë­í‚¹ ì„œë²„ ë¯¸ì—°ê²°</div>";
      fetch(SCRIPT_URL).then(res => res.json()).then(data => {
          let html = "";
          data.forEach(item => {
              let medal = "";
              if(item.rank === 1) medal = "ğŸ¥‡"; else if(item.rank === 2) medal = "ğŸ¥ˆ"; else if(item.rank === 3) medal = "ğŸ¥‰";
              else medal = `<span style="display:inline-block;width:15px;text-align:center;">${item.rank}</span>`;
              const displayName = (item.name && item.name.trim() !== "") ? item.name : "ìµëª…";
              html += `<div class="rank-item"><div style="display:flex;align-items:center;width:70%;">${medal} <span class="rank-name" style="margin-left:5px;">${displayName}</span></div><span class="rank-score">${item.score}ì </span></div>`;
          });
          if(data.length === 0) html = "<div style='text-align:center;padding:10px;'>ì•„ì§ ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
          rankList.innerHTML = html;
      }).catch(err => { rankList.innerHTML = "<div style='text-align:center; color:red;'>ë¡œë“œ ì‹¤íŒ¨</div>"; });
  }

  function startGame() {
    initAudio(); playBGM();    
    startOverlay.classList.add('hidden'); gameOverOverlay.classList.add('hidden');
    rankingOverlay.classList.add('hidden'); shopOverlay.classList.add('hidden');
    if(!isSpecialTheme) { document.body.className = ""; document.body.style.background = "var(--bg)"; stage.classList.remove('night', 'space'); }
    isRunning = true; score = 0; gameSpeed = 7.5; frameCount = 0; 
    obstacles = []; items = []; trails = [];
    playerY = 0; velocityY = 0; jumpCount = 0;
    feverGauge = 0; isFever = false;
    updateFeverUI();
    player.classList.remove('giant'); document.body.classList.remove('fever-mode');
    updatePlayerImage(); player.className = 'player running'; 
    if(myChar.type !== 'image') player.classList.add('emoji-char');
    player.style.bottom = GROUND_HEIGHT + "px"; 
    cooldownTimer = 0;
    document.querySelectorAll('.obstacle').forEach(e => e.remove());
    document.querySelectorAll('.item-star').forEach(e => e.remove());
    document.querySelectorAll('.milestone-text').forEach(e => e.remove());
    document.querySelectorAll('.dust').forEach(e => e.remove());
    document.querySelectorAll('.float-text').forEach(e => e.remove());
    document.querySelectorAll('.trail').forEach(e => e.remove());
    animationId = requestAnimationFrame(gameLoop);
  }
  function restartGame() { startGame(); }
  function backToSettings() {
    stopBGM(); gameOverOverlay.classList.add('hidden'); startOverlay.classList.remove('hidden');
    if(selectedBgType === 'basic') { document.body.className = ""; document.body.style.background = myBg; }
    stage.classList.remove('night', 'space', 'shake');
    document.body.classList.remove('fever-mode'); 
    isRunning = false; cancelAnimationFrame(animationId); checkHiddenUnlock();
  }

  function jump() {
    if (!isRunning) return;
    if (jumpCount < maxJumps) {
      velocityY = jumpPower; jumpCount++;
      if (audioCtx && !isMuted) createOscillator(600 + (jumpCount*200), audioCtx.currentTime, 0.1);
      player.classList.remove('running');
      if(jumpCount === 2) { player.classList.add('spin'); setTimeout(() => player.classList.remove('spin'), 500); }
    }
  }

  function showMilestone(text) {
      playSound('milestone'); const el = document.createElement('div'); el.className = 'milestone-text'; el.innerText = text; stage.appendChild(el); setTimeout(() => el.remove(), 1500);
  }
  
  function createDust() {
    const dust = document.createElement('div'); dust.className = 'dust';
    dust.style.left = '60px'; dust.style.bottom = (GROUND_HEIGHT - 5) + 'px';
    stage.appendChild(dust); setTimeout(() => dust.remove(), 400);
  }
  
  function createFloatText(x, y, text) {
    const el = document.createElement('div'); el.className = 'float-text'; el.innerText = text;
    el.style.left = x + 'px'; el.style.bottom = y + 'px';
    stage.appendChild(el); setTimeout(() => el.remove(), 800);
  }
  function createTrail() {
      const trail = document.createElement('div'); trail.className = 'trail';
      trail.style.bottom = player.style.bottom; trail.style.left = player.style.left;
      trail.style.transform = player.style.transform;
      trail.innerHTML = player.innerHTML; 
      stage.appendChild(trail);
      setTimeout(() => { trail.style.opacity = 0; setTimeout(() => trail.remove(), 300); }, 50);
  }

  function updateFeverUI() {
      feverBar.style.width = feverGauge + '%';
      if(feverGauge >= 100) feverBar.classList.add('full'); else feverBar.classList.remove('full');
  }
  function startFever() {
      if(isFever) return;
      isFever = true; originalSpeed = gameSpeed; gameSpeed += 5; 
      player.classList.add('giant'); document.body.classList.add('fever-mode'); showMilestone("FEVER TIME!! ğŸ”¥");
      setTimeout(endFever, 5000);
  }
  function endFever() {
      if(!isRunning) return;
      isFever = false; gameSpeed = originalSpeed + 0.5; feverGauge = 0; updateFeverUI();
      player.classList.remove('giant'); document.body.classList.remove('fever-mode');
      if(!isSpecialTheme) { if (score >= 2000) { document.body.classList.add('space'); } else if (score >= 600) { document.body.classList.add('night'); } }
  }

  function gameLoop() {
    if (!isRunning) return;
    frameCount++;
    if (!isFever && gameSpeed < maxSpeed) gameSpeed += acceleration;
    
    if (isFever && frameCount % 4 === 0) { createTrail(); }

    if (frameCount % 6 === 0) {
      score += (isFever ? 3 : 1); scoreEl.innerText = score;
      if(score === 1000) { showMilestone("HELL MODE ğŸ”¥"); } 
      else if (score % 500 === 0) { if (score !== 2000 || isSpecialTheme) { showMilestone(score + "!!"); } }
      if (!isSpecialTheme && !isFever) {
          if (score === 600) { document.body.classList.add('night'); stage.classList.add('night'); }
          if (score === 2000) { document.body.classList.remove('night'); document.body.classList.add('space'); showMilestone("SPACE! ğŸš€"); }
      }
    }

    playerY += velocityY; velocityY -= gravity;
    if (playerY <= 0) { 
      if (jumpCount > 0) { createDust(); player.classList.add('running'); }
      playerY = 0; jumpCount = 0; 
    }
    player.style.bottom = (GROUND_HEIGHT + playerY) + "px";

    if (cooldownTimer > 0) cooldownTimer--;
    let difficultyFactor = 150; 
    if (score > 500) difficultyFactor = 120;
    if (score > 1000) difficultyFactor = 90; 
    if (score > 2000) difficultyFactor = 70; 
    if (isFever) difficultyFactor = 60;

    let currentSpawnRate = Math.floor(difficultyFactor - (gameSpeed * 2));
    if (currentSpawnRate < 20) currentSpawnRate = 20; 

    if (cooldownTimer <= 0) { if (frameCount % currentSpawnRate === 0 || Math.random() < 0.05) createObstacle(); }
    if (frameCount % 200 === 0 && Math.random() < 0.5) createItem();
    
    moveObstacles(); moveItems();
    animationId = requestAnimationFrame(gameLoop);
  }

  function createItem() {
      const item = document.createElement('div'); item.className = 'item-star'; item.innerText = 'â­';
      const startX = stage.clientWidth + 50; item.xPos = startX; item.style.left = startX + 'px';
      const itemH = GROUND_HEIGHT + 50 + Math.random() * 50; item.style.bottom = itemH + 'px';
      stage.appendChild(item); items.push(item);
  }

  function moveItems() {
      for (let i = items.length - 1; i >= 0; i--) {
          let item = items[i]; item.xPos -= gameSpeed; item.style.left = item.xPos + "px";
          if (item.xPos > 50 && item.xPos < 90) {
              const itemBot = parseInt(item.style.bottom);
              if (playerY + GROUND_HEIGHT + 60 > itemBot && playerY + GROUND_HEIGHT < itemBot + 40) {
                  score += 50; scoreEl.innerText = score; playSound('coin'); 
                  createFloatText(70, parseInt(item.style.bottom)+20, "+50");
                  if (!isFever) { feverGauge = Math.min(feverGauge + 20, 100); updateFeverUI(); if (feverGauge >= 100) startFever(); }
                  item.remove(); items.splice(i, 1); continue;
              }
          }
          if (item.xPos < -50) { item.remove(); items.splice(i, 1); }
      }
  }

  function createObstacle() {
    const obs = document.createElement('div'); obs.classList.add('obstacle');
    const rand = Math.random(); const startX = stage.clientWidth + 50; obs.xPos = startX; obs.style.left = startX + "px"; 
    let isTutorial = score < 500; let isFairZone = (score >= 1000 && score < 2000); let highBirdChance = 0; if (score > 2000) highBirdChance = 0.5; 

    if (rand < 0.3) { 
      if (isTutorial) {
          obs.innerText = "ğŸŒµ"; obs.classList.add('ground'); obs.style.bottom = GROUND_HEIGHT + "px"; obs.type = 'ground'; cooldownTimer = 50; 
      } else {
          obs.innerText = "ğŸ¦…"; obs.classList.add('bird');
          if (isFairZone) {
             obs.style.bottom = (GROUND_HEIGHT + 15) + "px"; obs.type = 'air_low'; cooldownTimer = 60; 
          } else {
             if (Math.random() < highBirdChance) {
                obs.style.bottom = (GROUND_HEIGHT + 75) + "px"; obs.type = 'air_high'; obs.classList.add('high-danger'); cooldownTimer = 30; 
             } else {
                obs.style.bottom = (GROUND_HEIGHT + 15) + "px"; obs.type = 'air_low'; cooldownTimer = 25; 
             }
          }
      }
    } else if (rand < 0.5) {
      if (isFairZone) {
          obs.innerText = "ğŸŒµ"; obs.classList.add('ground'); obs.style.bottom = GROUND_HEIGHT + "px"; obs.type = 'ground'; cooldownTimer = 60;
      } else {
          obs.innerText = "ğŸŒ²"; obs.classList.add('tall'); obs.style.bottom = GROUND_HEIGHT + "px"; obs.type = 'tall'; cooldownTimer = 40; 
      }
    } else {
      obs.innerText = Math.random() < 0.5 ? "ğŸŒµ" : "ğŸª¨"; obs.style.bottom = GROUND_HEIGHT + "px"; obs.type = 'ground';
      if (isFairZone) cooldownTimer = 55; else cooldownTimer = (score < 1000) ? 50 : 25;
    }
    stage.appendChild(obs); obstacles.push(obs);
  }

  function moveObstacles() {
    for (let i = obstacles.length - 1; i >= 0; i--) {
      let obs = obstacles[i]; 
      
      if (obs.isSmashed) {
      } else {
          obs.xPos -= gameSpeed; 
          obs.style.left = obs.xPos + "px";
      }

      // ğŸ¯ íˆíŠ¸ë°•ìŠ¤ ì •êµí™”
      const pLeft = 50 + 25;
      const pRight = 50 + 90 - 25;
      const pBottom = playerY + 20; 
      const pTop = playerY + 90 - 20;

      const oLeft = obs.xPos + 10;
      const oRight = obs.xPos + 50 - 10;
      const oBottom = parseInt(obs.style.bottom) - GROUND_HEIGHT; 
      const oTop = oBottom + 50; 

      // ì¶©ëŒ ì²´í¬
      if (!obs.isSmashed && pRight > oLeft && pLeft < oRight && pTop > oBottom && pBottom < oTop) {
          if (isFever) {
              obs.isSmashed = true; obs.classList.add('smashed'); 
              stage.classList.add('smash-shake'); setTimeout(() => stage.classList.remove('smash-shake'), 200);
              playSound('smash');
              createFloatText(obs.xPos, parseInt(obs.style.bottom)+50, "ğŸ’¥");
              score += 10; continue; 
          } else {
              gameOver(); return; 
          }
      }
      
      if (obs.xPos < -60) { obs.remove(); obstacles.splice(i, 1); }
    }
  }

  function gameOver() {
    stopBGM(); if (audioCtx && !isMuted) createOscillator(150, audioCtx.currentTime, 0.5, 'sawtooth');
    
    player.classList.remove('running');
    player.classList.add('dead');
    
    stage.classList.add('shake');
    if (navigator.vibrate) navigator.vibrate(200);
    setTimeout(() => { stage.classList.remove('shake'); }, 500);
    isRunning = false; cancelAnimationFrame(animationId);
    
    const final = Math.floor(score); finalScoreEl.innerText = final; rankText.innerText = `ğŸ† ë“±ê¸‰: ${getRank(final)}`;
    
    // ì ìˆ˜ ì •ì‚° ë° ì½”ì¸ ì €ì¥
    totalCoins += final; 
    localStorage.setItem('runnerCoins', totalCoins);
    updateCoinUI();

    if (final >= 1000) fortuneContainer.innerHTML = '<button class="btn-fortune" onclick="openFortune()">ğŸ¥  ì˜¤ëŠ˜ì˜ ìš´ì„¸ ì—´ê¸° (Click!)</button>';
    else fortuneContainer.innerHTML = '<div class="locked-fortune">ğŸ”’ 1,000ì  ë‹¬ì„± ì‹œ ì˜¤ëŠ˜ì˜ ìš´ì„¸ê°€ ì—´ë¦½ë‹ˆë‹¤!</div>';

    unlockMsg.classList.add('hidden');
    if (score > best) { best = score; localStorage.setItem('runnerBest', best); bestScoreEl.innerText = best; }
    
    let newUnlocks = [];
    if (best >= UNLOCK_SCORE_DRAGON && !document.getElementById('hiddenDragon')) newUnlocks.push("ìš©(ğŸ²)");
    if (best >= UNLOCK_SCORE_TIGER && !document.getElementById('hiddenTiger')) newUnlocks.push("í˜¸ë‘ì´(ğŸ¯)");
    if (best >= BG_UNLOCK_AURORA && !document.getElementById('bgAurora')) newUnlocks.push("ì˜¤ë¡œë¼ ë°°ê²½(ğŸŒˆ)");
    if (best >= BG_UNLOCK_SPACE && !document.getElementById('bgSpace')) newUnlocks.push("ìš°ì£¼ ë°°ê²½(ğŸš€)");
    
    if (newUnlocks.length > 0) {
        unlockMsg.innerHTML = `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! <b>${newUnlocks.join(", ")}</b> í•´ê¸ˆ ì™„ë£Œ!`;
        unlockMsg.classList.remove('hidden');
        checkHiddenUnlock();
    }
    
    setTimeout(() => {
        gameOverOverlay.classList.remove('hidden');
        player.classList.remove('dead');
    }, 800);
  }

  window.addEventListener('keydown', (e) => { if (e.code === 'Space') { if (!isRunning) { if (!startOverlay.classList.contains('hidden')) startGame(); else if (!gameOverOverlay.classList.contains('hidden')) restartGame(); return; } jump(); } });
  stage.addEventListener('touchstart', (e) => { if (e.target.closest('button') || e.target.closest('.chip') || e.target.closest('.sound-toggle') || e.target.closest('.rank-input') || e.target.closest('.shop-box')) return; e.preventDefault(); if (isRunning) jump(); else if (!startOverlay.classList.contains('hidden')) startGame(); else if (!gameOverOverlay.classList.contains('hidden')) restartGame(); }, { passive: false });
  stage.addEventListener('mousedown', (e) => { if (e.target.closest('button') || e.target.closest('.chip') || e.target.closest('.sound-toggle') || e.target.closest('.rank-input') || e.target.closest('.shop-box')) return; if (isRunning) jump(); });
</script>
</body>
</html>