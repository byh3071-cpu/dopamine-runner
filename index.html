<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Dopamine Runner: Gacha Shop ğŸ²</title>
  
  <style>
    @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

    :root{ --bg:#fde2ff; --panel: rgba(255,255,255,.95); --ink:#2a2a2a; --shadow: 0 4px 10px rgba(0,0,0,.1); --round: 20px; --ground-height: 40px; --accent: #6200ea; }
    * { box-sizing: border-box; }
    
    /* ê¸°ë³¸ ë°°ê²½ ì„¤ì • */
    body { 
        margin:0; height: 100dvh; display:flex; justify-content: center; align-items: center; 
        background-color: var(--bg); 
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        font-family: "Pretendard", sans-serif; color:var(--ink); overflow:hidden; 
        touch-action: none; user-select: none; -webkit-user-select: none; 
        transition: background-image 0.5s ease; 
    }

    /* ğŸ”¥ [ë°°ê²½ ì´ë¯¸ì§€ ì—°ê²° - PNG ë²„ì „] */
    body.bg-pink { background-image: url('bg_pink.png') !important; color: #333; }
    body.bg-sky { background-image: url('bg_sky.png') !important; color: #333; }
    body.bg-green { background-image: url('bg_green.png') !important; color: #333; }
    
    /* ì–´ë‘ìš´ í…Œë§ˆ ë°°ê²½ */
    body.sunset { background-image: url('bg_sunset.png') !important; color: white !important; }
    body.night { background-image: url('bg_midnight.png') !important; color: white !important; }
    body.midnight { background-image: url('bg_midnight.png') !important; color: white !important; }
    body.space { background-image: url('bg_space.png') !important; color: white !important; }
    body.aurora { background-image: url('bg_aurora.png') !important; color: white !important; }

    /* í”¼ë²„ ëª¨ë“œ (ë¬´ì§€ê°œ) */
    body.fever-mode { 
        background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000) !important; 
        background-size: 400%; 
        animation: rainbowBg 0.5s linear infinite !important; 
        color: white !important; 
    }
    @keyframes rainbowBg { 0% {background-position: 0%;} 100% {background-position: 400%;} }

    .app{ width: 100%; height: 100%; position:relative; display: flex; flex-direction: column; }
    .top-container { position: relative; margin: 20px; z-index: 20; flex-shrink: 0; }
    
    /* ğŸ† ìƒë‹¨ ì ìˆ˜íŒ & ì½”ì¸ UI */
    .topbar{ display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:var(--panel); border-radius:var(--round); box-shadow: var(--shadow); font-weight: bold; color: #2a2a2a !important; }
    .score-box span{ background: white; padding: 5px 12px; border-radius: 15px; margin-left: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #333; font-weight: 900; }
    
    /* ì½”ì¸ í‘œì‹œ (ì˜¤ë¥¸ìª½ ìƒë‹¨ ì‚ì£½) */
    .coin-display { position: absolute; top: -12px; right: 15px; background: #FFD700; color: #333; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: 900; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 25; border: 2px solid #fff; }

    /* í”¼ë²„ ê²Œì´ì§€ ë°” */
    .fever-bar-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 8px; overflow: hidden; border: 2px solid rgba(255,255,255,0.5); }
    .fever-bar-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #fbc02d, #ffeb3b); transition: width 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 0 10px #ffeb3b; }
    .fever-bar-fill.full { background: linear-gradient(90deg, #ff0000, #ffff00); animation: pulseBar 0.2s infinite; }
    @keyframes pulseBar { 0%{opacity:1;} 50%{opacity:0.7;} 100%{opacity:1;} }

    .stage{ position:relative; flex-grow: 1; width: 100%; border-radius: var(--round); box-shadow: var(--shadow); background: transparent; overflow:hidden; user-select:none; cursor: pointer; transform: translateZ(0); }
    .stage.shake { animation: shakeAnim 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shakeAnim { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

    /* ë°”ë‹¥ */
    .ground{ position: absolute; bottom:0; width: 100%; height: var(--ground-height); background: rgba(255,255,255,0.6); border-top: 3px solid rgba(255,255,255,0.8); transition: background 1.5s; }
    body.night .ground, body.space .ground, body.aurora .ground, body.midnight .ground, body.sunset .ground { background: rgba(255,255,255,0.15); border-top: 3px solid rgba(255,255,255,0.3); }

    /* ìºë¦­í„° */
    .player { position: absolute; left: 50px; bottom: var(--ground-height); width: 90px; height: 90px; z-index: 10; transform-origin: center; transition: transform 0.3s; display:flex; align-items:center; justify-content:center; font-size: 60px; }
    .player img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2)); transition: transform 0.1s; }
    .player.giant { transform: scale(1.5); filter: drop-shadow(0 0 15px gold); }
    
    @keyframes runWobble { 0% { transform: rotate(-3deg) translateY(0); } 25% { transform: rotate(0deg) translateY(-2px); } 50% { transform: rotate(3deg) translateY(0); } 75% { transform: rotate(0deg) translateY(-2px); } 100% { transform: rotate(-3deg) translateY(0); } }
    .player.running img, .player.running.emoji-char { animation: runWobble 0.3s infinite linear; }
    .spin img, .spin.emoji-char { animation: spinPlayer 0.5s ease-in-out; }
    @keyframes spinPlayer { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .player.dead { animation: knockback 0.8s forwards ease-out; }
    @keyframes knockback { 0% { transform: scale(1) rotate(0deg); opacity: 1; } 100% { transform: scale(0.8) rotate(720deg) translate(200px, -200px); opacity: 0; } }

    /* ì¥ì• ë¬¼ ë° ì•„ì´í…œ */
    .obstacle{ position:absolute; width:50px; height:50px; font-size:40px; display:flex; align-items:center; justify-content:center; }
    .obstacle.bird { animation: fly 0.6s infinite alternate ease-in-out; font-size: 45px; }
    @keyframes fly { from { transform: translateY(0); } to { transform: translateY(-10px); } }
    body.night .obstacle, body.space .obstacle, body.aurora .obstacle { filter: brightness(1.2); }
    
    .item-star { position: absolute; width: 40px; height: 40px; font-size: 35px; display: flex; align-items: center; justify-content: center; z-index: 9; animation: spinStar 2s infinite linear; }
    @keyframes spinStar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .float-text { position: absolute; font-weight: 900; color: #ffeb3b; font-size: 24px; z-index: 50; pointer-events: none; text-shadow: 2px 2px 0 #000; animation: floatUp 0.8s forwards; }
    @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }
    .milestone-text { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; font-weight: bold; color: #FFD700; text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 50; animation: popFade 1.5s forwards; }
    @keyframes popFade { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 30% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -100%) scale(1.5); opacity: 0; } }

    /* UI íŒì—… (ì„¤ì •, ìƒì , ê²Œì„ì˜¤ë²„) */
    .overlay{ position:absolute; inset:0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display:flex; justify-content:center; align-items:center; z-index: 100; }
    .panel{ background: white; padding: 25px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align:center; width: 90%; max-width: 450px; max-height: 85vh; display: flex; flex-direction: column; }
    .hidden { display: none !important; }

    .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
    .chip { padding: 10px 14px; border: 2px solid #eee; border-radius: 20px; cursor: pointer; font-weight: bold; background: #fafafa; font-size: 14px; color: #aaa; filter: grayscale(1); } 
    .chip.owned { color: #333; filter: grayscale(0); border-color: #ddd; } 
    .chip.selected { border-color: #333; background: #333; color: white !important; box-shadow: 0 5px 15px rgba(0,0,0,0.2); filter: none; }
    .chip.bg-unlocked { border-color: #00b894; background: #f0fffa; color: #006266; filter: none; opacity: 1;}
    .chip.bg-unlocked.selected { background: #00b894; color: white; }

    .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }
    button { border: none; padding: 12px 20px; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
    button:active { transform: scale(0.95); }
    .btn-primary { background: #333; color: white; flex: 1; }
    .btn-shop { background: #FFD700; color: #333; flex: 1; border: 2px solid #e6c200; }
    .btn-secondary { background: #f0f0f0; color: #333; flex: 1; }
    .btn-rank { background: var(--accent); color: white; flex: 1; }
    .btn-submit { background: var(--accent); color: white; flex: 0 0 60px; }

    /* ìƒì  ë°•ìŠ¤ */
    .shop-area { text-align: center; margin-top: 10px; }
    .shop-box { width: 120px; height: 120px; margin: 0 auto; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" x="10" font-size="80">ğŸ</text></svg>') no-repeat center; background-size: contain; cursor: pointer; }
    .shop-box.shaking { animation: boxShake 0.5s infinite; }
    @keyframes boxShake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
    .gacha-msg { font-size: 18px; font-weight: bold; color: var(--accent); min-height: 24px; margin-bottom: 10px; }

    .sound-toggle { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; z-index: 30; background: rgba(255,255,255,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .rank-form { display: flex; gap: 5px; margin-top: 10px; flex-shrink: 0; }
    .rank-input { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-weight: bold; }
    .rank-list { margin-top: 10px; flex: 1; min-height: 0; overflow-y: auto; text-align: left; font-size: 13px; background: #fff; border: 1px solid #eee; padding: 5px; border-radius: 10px; }
    .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0; color: #333 !important; }
    .fortune-area { margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 10px; text-align: center; }
    .btn-fortune { background: linear-gradient(45deg, #ff9a9e, #fad0c4); color: white; width: 100%; border: none; }
    .fortune-msg { font-size: 15px; color: #d48806; font-weight: bold; animation: popUp 0.5s; line-height: 1.4; }
  </style>
</head>
<body class="bg-pink"> 

<div class="app">
  <div class="top-container">
    <div class="topbar">
      <div>ğŸƒ Dopamine Runner</div>
      <div class="score-box">
        ìµœê³  <span id="bestScore">0</span> | ì ìˆ˜ <span id="currentScore">0</span>
      </div>
    </div>
    <div class="coin-display">ğŸ’° <span id="userCoins">0</span></div>
    <div class="fever-bar-bg">
        <div id="feverBar" class="fever-bar-fill"></div>
    </div>
  </div>

  <div class="stage" id="gameStage">
    <div class="player" id="player"></div>
    <div class="ground"></div>
    <div class="sound-toggle" id="soundBtn" title="ë°°ê²½ìŒì•…">ğŸ”Š</div>

    <div class="overlay" id="startOverlay">
      <div class="panel">
        <h1>ê²Œì„ ì„¤ì •</h1>
        <p>ë³´ìœ  ì½”ì¸: ğŸ’° <span id="startCoins">0</span></p>
        <div class="options-group">
          <span style="font-size:13px; font-weight:bold; color:#888;">ìºë¦­í„°</span>
          <div class="chips" id="charOptions"></div>
        </div>
        <div class="options-group">
          <span style="font-size:13px; font-weight:bold; color:#888;">ë°°ê²½ í…Œë§ˆ</span>
          <div class="chips" id="bgOptions">
            <div class="chip selected" onclick="selectBg('bg-pink', this)">ğŸŒ¸ ë¶„í™</div>
            <div class="chip" onclick="selectBg('bg-sky', this)">â˜ï¸ í•˜ëŠ˜</div>
            <div class="chip" onclick="selectBg('bg-green', this)">ğŸŒ¿ ì—°ë‘</div>
          </div>
        </div>
        <div class="btn-group">
            <button class="btn-shop" onclick="openShop()">ğŸª ìƒì </button>
            <button class="btn-primary" onclick="startGame()">ê²Œì„ ì‹œì‘ ğŸµ</button>
        </div>
      </div>
    </div>

    <div class="overlay hidden" id="shopOverlay">
        <div class="panel">
            <h2>ğŸª ìŠ¤í‚¨ ìƒì </h2>
            <p>500ì½”ì¸ìœ¼ë¡œ ëœë¤ ìŠ¤í‚¨ ë½‘ê¸°!<br>(ì¤‘ë³µ ì‹œ 300ì½”ì¸ í™˜ê¸‰)</p>
            <div style="font-weight:bold; margin-bottom:10px;">ë³´ìœ : ğŸ’° <span id="shopCoins">0</span></div>
            <div class="shop-area">
                <div id="gachaBox" class="shop-box" onclick="drawGacha()"></div>
                <div id="gachaResult" class="gacha-msg"></div>
                <button class="btn-primary" onclick="drawGacha()">ğŸ² ë½‘ê¸°</button>
            </div>
            <div style="margin-top:15px;">
                <button class="btn-secondary" onclick="closeShop()">â†©ï¸ ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <div class="overlay hidden" id="gameOverOverlay">
      <div class="panel">
        <h1>ê²Œì„ ì˜¤ë²„!</h1>
        <p>ì ìˆ˜: <span id="finalScore">0</span></p>
        <div class="fortune-area" id="fortuneContainer"></div>
        <div id="unlockMsg" class="hidden" style="color:#d48806; font-weight:bold; margin-bottom:15px; background:#fffbe6; padding:10px; border-radius:10px;"></div>
        <div class="btn-group">
          <button class="btn-secondary" onclick="backToSettings()">âš™ï¸ ì„¤ì •</button>
          <button class="btn-primary" onclick="restartGame()">ğŸ”„ ì¬ì‹œì‘</button>
        </div>
        <div class="btn-group" style="margin-top:5px;">
            <button class="btn-rank" onclick="openRanking()">ğŸ† ë­í‚¹ ë³´ê¸°</button>
        </div>
        <div class="btn-group" style="margin-top:5px;">
            <button class="btn-secondary" onclick="shareScore()">ğŸ”— ê³µìœ í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <div class="overlay hidden" id="rankingOverlay">
        <div class="panel" style="height:85vh;">
            <h2>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            <div class="rank-form">
                <input type="text" id="nicknameInput" class="rank-input" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ì)" maxlength="8">
                <button class="btn-submit" onclick="submitRank()">ë“±ë¡</button>
            </div>
            <div id="rankList" class="rank-list">
                <div style="text-align:center; padding:20px; color:#999;">ë¡œë”© ì¤‘...</div>
            </div>
            <div style="margin-top:15px;">
                <button class="btn-secondary" onclick="closeRanking()">â†©ï¸ ë’¤ë¡œê°€ê¸°</button>
            </div>
        </div>
    </div>

  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4oxlHh4I9KvBj1rlgTdDCxFDrpwMugkfFzNZOMIG1ZzakJb93QD2KVdnmY2LuqOQZ3Q/exec"; 

  const player = document.getElementById('player');
  const stage = document.getElementById('gameStage');
  const startOverlay = document.getElementById('startOverlay');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const shopOverlay = document.getElementById('shopOverlay');
  const rankingOverlay = document.getElementById('rankingOverlay');
  
  const scoreEl = document.getElementById('currentScore');
  const finalScoreEl = document.getElementById('finalScore');
  const bestScoreEl = document.getElementById('bestScore');
  const userCoinsEl = document.getElementById('userCoins');
  const startCoinsEl = document.getElementById('startCoins');
  const shopCoinsEl = document.getElementById('shopCoins');
  const charOptions = document.getElementById('charOptions');
  const bgOptions = document.getElementById('bgOptions');
  const gachaBox = document.getElementById('gachaBox');
  const gachaResult = document.getElementById('gachaResult');
  const feverBar = document.getElementById('feverBar');
  const soundBtn = document.getElementById('soundBtn');
  const rankList = document.getElementById('rankList');
  const nicknameInput = document.getElementById('nicknameInput');
  const fortuneContainer = document.getElementById('fortuneContainer');
  const unlockMsg = document.getElementById('unlockMsg');

  let myChar = { type: 'image', val: 'dog.png' }; 
  let best = Number(localStorage.getItem('runnerBest') || 0);
  let totalCoins = Number(localStorage.getItem('runnerCoins') || 0);
  let ownedSkins = JSON.parse(localStorage.getItem('runnerSkins') || '["dog.png"]');

  const SKIN_DB = [
      { id: 'dog.png', name: 'ğŸ¶ ê°•ì•„ì§€', type: 'image', obtain: 'default' },
      { id: 'cat.png', name: 'ğŸ± ê³ ì–‘ì´', type: 'image', obtain: 'gacha' },
      { id: 'rabbit.png', name: 'ğŸ° í† ë¼', type: 'image', obtain: 'gacha' },
      { id: 'ğŸ¼', name: 'ğŸ¼ íŒë‹¤', type: 'emoji', obtain: 'gacha' },
      { id: 'ğŸ‘½', name: 'ğŸ‘½ ì™¸ê³„ì¸', type: 'emoji', obtain: 'gacha' },
      { id: 'ğŸ¦„', name: 'ğŸ¦„ ìœ ë‹ˆì½˜', type: 'emoji', obtain: 'gacha' }
  ];

  let isRunning = false;
  let score = 0;
  let animationId;
  let frameCount = 0;
  let gameSpeed = 7.5;
  let playerY = 0;
  let velocityY = 0;
  let jumpCount = 0;
  let feverGauge = 0;
  let isFever = false;
  const gravity = 0.8;
  const jumpPower = 14;
  const GROUND_HEIGHT = 40;
  let obstacles = [];
  let items = [];

  // ëˆ„ë½ë˜ì—ˆë˜ í•´ê¸ˆ ì ìˆ˜ ìƒìˆ˜ ì •ì˜ (ì¶”ê°€ë¨)
  const UNLOCK_SCORE_TIGER = 1000;
  const UNLOCK_SCORE_DRAGON = 2000;
  const BG_UNLOCK_SUNSET = 1000;
  const BG_UNLOCK_MIDNIGHT = 1500;
  const BG_UNLOCK_SPACE = 2000;
  const BG_UNLOCK_AURORA = 2500;

  // ì˜¤ë””ì˜¤ ì„¤ì •
  let audioCtx = null;
  let isMuted = false;

  // ì´ˆê¸°í™”
  bestScoreEl.innerText = best;
  updateCoinUI();
  renderCharOptions();
  updatePlayerImage();
  checkHiddenUnlock();

  // --- ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ---
  function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
  
  function playBGM() {
    if (isMuted || !audioCtx) return; stopBGM(); 
    const notes = [392, 392, 440, 392, 523, 493, 392, 392, 440, 392, 587, 523]; 
    let time = audioCtx.currentTime;
    notes.forEach((freq, index) => createOscillator(freq, time + index * 0.4, 0.2, 'square'));
    window.bgmInterval = setInterval(() => {
       if(!isRunning || isMuted) { clearInterval(window.bgmInterval); return; }
       let t = audioCtx.currentTime;
       notes.forEach((freq, index) => createOscillator(freq, t + index * 0.4, 0.2, 'square'));
    }, notes.length * 400);
  }

  function createOscillator(freq, startTime, duration, type = 'square') {
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.03, startTime); gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination); osc.start(startTime); osc.stop(startTime + duration);
  }

  function playSound(type) {
      if(!audioCtx || isMuted) return;
      if(type === 'coin') { createOscillator(880, audioCtx.currentTime, 0.1, 'sine'); createOscillator(1760, audioCtx.currentTime + 0.1, 0.2, 'sine'); }
      else if(type === 'milestone') { createOscillator(523, audioCtx.currentTime, 0.2, 'triangle'); createOscillator(659, audioCtx.currentTime + 0.1, 0.2, 'triangle'); }
      else if(type === 'smash') { createOscillator(150, audioCtx.currentTime, 0.1, 'sawtooth'); }
  }

  function stopBGM() { if (window.bgmInterval) clearInterval(window.bgmInterval); }
  
  soundBtn.addEventListener('click', (e) => { 
      e.stopPropagation(); isMuted = !isMuted; 
      soundBtn.innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š"; 
      if(isMuted) stopBGM(); else if(isRunning) playBGM(); 
  });

  // --- ê²Œì„ ë¡œì§ ---
  function updateCoinUI() {
      userCoinsEl.innerText = totalCoins;
      startCoinsEl.innerText = totalCoins;
      shopCoinsEl.innerText = totalCoins;
      localStorage.setItem('runnerCoins', totalCoins);
  }

  function updatePlayerImage() { 
      if (myChar.type === 'image') {
          player.innerHTML = `<img src="${myChar.val}" alt="Char">`;
          player.classList.remove('emoji-char');
      } else {
          player.innerHTML = myChar.val;
          player.classList.add('emoji-char');
      }
  }

  function selectBg(className, element) {
      document.body.className = className;
      document.querySelectorAll('#bgOptions .chip').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
  }

  function openShop() { startOverlay.classList.add('hidden'); shopOverlay.classList.remove('hidden'); }
  function closeShop() { shopOverlay.classList.add('hidden'); startOverlay.classList.remove('hidden'); renderCharOptions(); }

  function drawGacha() {
      if (totalCoins < 500) return alert("ì½”ì¸ì´ ë¶€ì¡±í•´ìš”! (500 í•„ìš”)");
      totalCoins -= 500; updateCoinUI();
      gachaBox.classList.add('shaking'); gachaResult.innerText = "ë‘ê·¼ë‘ê·¼...";
      
      setTimeout(() => {
          gachaBox.classList.remove('shaking');
          const gachaPool = SKIN_DB.filter(s => s.obtain === 'gacha');
          const picked = gachaPool[Math.floor(Math.random() * gachaPool.length)];
          let msg = "";
          if (ownedSkins.includes(picked.id)) {
              totalCoins += 300; updateCoinUI(); msg = `ğŸ’¥ ì¤‘ë³µ! [${picked.name}] (300ì½”ì¸ í™˜ê¸‰)`;
          } else {
              ownedSkins.push(picked.id); localStorage.setItem('runnerSkins', JSON.stringify(ownedSkins)); msg = `ğŸ‰ [${picked.name}] íšë“!`; playSound('milestone');
          }
          gachaResult.innerText = msg;
      }, 1000);
  }

  function renderCharOptions() {
      charOptions.innerHTML = "";
      SKIN_DB.forEach(skin => {
          const isOwned = ownedSkins.includes(skin.id);
          const el = document.createElement('div');
          el.className = `chip ${isOwned ? 'owned' : ''} ${myChar.val === skin.id ? 'selected' : ''}`;
          el.innerText = skin.name;
          if (!isOwned) el.style.opacity = "0.5";
          else el.onclick = () => selectChar(skin.id, skin.type);
          charOptions.appendChild(el);
      });
  }

  function selectChar(id, type) {
      myChar = { type: type, val: id }; renderCharOptions(); updatePlayerImage();
  }

  function checkHiddenUnlock() {
      if (best >= 1000 && !document.getElementById('bgSunset')) addBgOption('bg-sunset', 'ğŸ”¥ ë…¸ì„', 'bgSunset');
      if (best >= 1500 && !document.getElementById('bgMidnight')) addBgOption('bg-midnight', 'ğŸŒƒ ì‹¬í•´', 'bgMidnight');
      if (best >= 2000 && !document.getElementById('bgSpace')) addBgOption('bg-space', 'ğŸš€ ìš°ì£¼', 'bgSpace');
      if (best >= 2500 && !document.getElementById('bgAurora')) addBgOption('bg-aurora', 'ğŸŒˆ ì˜¤ë¡œë¼', 'bgAurora');
  }

  function addBgOption(cls, name, id) {
      const chip = document.createElement('div');
      chip.id = id; chip.className = 'chip bg-unlocked'; chip.innerText = name;
      chip.onclick = function() { selectBg(cls, this); };
      bgOptions.appendChild(chip);
  }

  function startGame() {
      initAudio(); playBGM();
      startOverlay.classList.add('hidden'); gameOverOverlay.classList.add('hidden'); shopOverlay.classList.add('hidden'); rankingOverlay.classList.add('hidden');
      isRunning = true; score = 0; gameSpeed = 7.5; frameCount = 0; obstacles = []; items = [];
      playerY = 0; velocityY = 0; jumpCount = 0; feverGauge = 0; isFever = false;
      document.querySelectorAll('.obstacle').forEach(e => e.remove());
      document.querySelectorAll('.item-star').forEach(e => e.remove());
      document.querySelectorAll('.float-text').forEach(e => e.remove());
      player.classList.remove('dead'); player.classList.add('running');
      updateFeverUI();
      animationId = requestAnimationFrame(gameLoop);
  }

  function restartGame() { startGame(); }
  function backToSettings() {
      stopBGM(); gameOverOverlay.classList.add('hidden'); startOverlay.classList.remove('hidden');
      isRunning = false; cancelAnimationFrame(animationId); checkHiddenUnlock();
  }

  function jump() {
      if (!isRunning) return;
      if (jumpCount < 2) { velocityY = jumpPower; jumpCount++; }
  }

  function updateFeverUI() {
      feverBar.style.width = feverGauge + '%';
      if(feverGauge >= 100) feverBar.classList.add('full'); else feverBar.classList.remove('full');
  }

  function createFloatText(x, y, text) {
      const el = document.createElement('div'); el.className = 'float-text'; el.innerText = text;
      el.style.left = x + 'px'; el.style.bottom = y + 'px';
      stage.appendChild(el); setTimeout(() => el.remove(), 800);
  }

  function gameLoop() {
      if (!isRunning) return;
      frameCount++;
      if (!isFever && gameSpeed < 25) gameSpeed += 0.0015;
      if (frameCount % 6 === 0) { score += (isFever ? 3 : 1); scoreEl.innerText = score; }

      playerY += velocityY; velocityY -= gravity;
      if (playerY <= 0) { playerY = 0; jumpCount = 0; }
      player.style.bottom = (GROUND_HEIGHT + playerY) + "px";

      if (frameCount % Math.floor(150 - gameSpeed*2) === 0 || Math.random() < 0.005) createObstacle();
      if (frameCount % 200 === 0 && Math.random() < 0.5) createItem();

      moveObstacles(); moveItems();
      animationId = requestAnimationFrame(gameLoop);
  }

  function createObstacle() {
      const obs = document.createElement('div');
      obs.classList.add('obstacle');
      obs.innerText = Math.random() < 0.3 ? "ğŸ¦…" : (Math.random() < 0.5 ? "ğŸŒµ" : "ğŸª¨");
      if (obs.innerText === "ğŸ¦…") obs.classList.add('bird');
      obs.xPos = stage.clientWidth + 50;
      obs.style.left = obs.xPos + "px";
      obs.style.bottom = (obs.innerText === "ğŸ¦…" ? GROUND_HEIGHT + 40 : GROUND_HEIGHT) + "px";
      stage.appendChild(obs); obstacles.push(obs);
  }

  function createItem() {
      const item = document.createElement('div');
      item.className = 'item-star'; item.innerText = 'â­';
      item.xPos = stage.clientWidth + 50;
      item.style.left = item.xPos + 'px';
      item.style.bottom = (GROUND_HEIGHT + 50 + Math.random() * 50) + 'px';
      stage.appendChild(item); items.push(item);
  }

  function moveObstacles() {
      for (let i = obstacles.length - 1; i >= 0; i--) {
          let obs = obstacles[i];
          obs.xPos -= gameSpeed; obs.style.left = obs.xPos + "px";
          if (obs.xPos > 50 && obs.xPos < 90) {
              const obsBottom = parseInt(obs.style.bottom);
              if (playerY < obsBottom + 30 && playerY + 50 > obsBottom) {
                  if (isFever) {
                      obs.remove(); obstacles.splice(i, 1); score += 10; createFloatText(obs.xPos, obsBottom+50, "ğŸ’¥"); playSound('smash'); continue;
                  } else { gameOver(); return; }
              }
          }
          if (obs.xPos < -50) { obs.remove(); obstacles.splice(i, 1); }
      }
  }

  function moveItems() {
      for (let i = items.length - 1; i >= 0; i--) {
          let item = items[i];
          item.xPos -= gameSpeed; item.style.left = item.xPos + "px";
          if (item.xPos > 50 && item.xPos < 90) {
              const itemH = parseInt(item.style.bottom);
              if (playerY + GROUND_HEIGHT + 60 > itemH && playerY + GROUND_HEIGHT < itemH + 40) {
                  score += 50; createFloatText(70, itemH+20, "+50"); playSound('coin');
                  if (!isFever) { 
                      feverGauge = Math.min(feverGauge + 20, 100); updateFeverUI(); 
                      if (feverGauge >= 100) { isFever = true; document.body.classList.add('fever-mode'); setTimeout(() => { isFever = false; document.body.classList.remove('fever-mode'); feverGauge = 0; updateFeverUI(); }, 5000); }
                  }
                  item.remove(); items.splice(i, 1); continue;
              }
          }
          if (item.xPos < -50) { item.remove(); items.splice(i, 1); }
      }
  }

  function gameOver() {
      stopBGM();
      isRunning = false; cancelAnimationFrame(animationId);
      finalScoreEl.innerText = Math.floor(score);
      totalCoins += Math.floor(score);
      localStorage.setItem('runnerCoins', totalCoins);
      if (score > best) { best = score; localStorage.setItem('runnerBest', best); }
      updateCoinUI(); checkHiddenUnlock();
      
      // ì˜¤ëŠ˜ì˜ ìš´ì„¸
      const fortunes = ["ğŸ€ ì†Œì†Œí•œ í–‰ìš´!", "ğŸŒ ì˜¤ëŠ˜ì€ ëŒ€ë°• ë‚ !", "ğŸ’– ì‚¬ë‘ì´ ì°¾ì•„ì˜¬ì§€ë„?", "ğŸ’° ëœ»ë°–ì˜ ìš©ëˆì´?!"];
      const msg = fortunes[Math.floor(Math.random() * fortunes.length)];
      fortuneContainer.innerHTML = (score >= 1000) ? `<button class="btn-fortune" onclick="this.innerText='${msg}'">ğŸ¥  ìš´ì„¸ ë½‘ê¸°</button>` : "<div style='color:#999; font-size:13px;'>ğŸ”’ 1000ì  ì´ìƒ ì‹œ ìš´ì„¸ ì ê¸ˆí•´ì œ</div>";

      // ğŸ† í•´ê¸ˆ ì•Œë¦¼ ë¡œì§ (ë³€ìˆ˜ ëˆ„ë½ ìˆ˜ì •ë¨)
      let newUnlocks = [];
      if (best >= UNLOCK_SCORE_DRAGON && !document.getElementById('hiddenDragon')) newUnlocks.push("ìš©(ğŸ²)");
      if (best >= UNLOCK_SCORE_TIGER && !document.getElementById('hiddenTiger')) newUnlocks.push("í˜¸ë‘ì´(ğŸ¯)");
      if (best >= BG_UNLOCK_AURORA && !document.getElementById('bgAurora')) newUnlocks.push("ì˜¤ë¡œë¼ ë°°ê²½(ğŸŒˆ)");
      if (best >= BG_UNLOCK_SPACE && !document.getElementById('bgSpace')) newUnlocks.push("ìš°ì£¼ ë°°ê²½(ğŸš€)");
      
      if (newUnlocks.length > 0) {
          unlockMsg.innerHTML = `ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! <b>${newUnlocks.join(", ")}</b> í•´ê¸ˆ ì™„ë£Œ!`;
          unlockMsg.classList.remove('hidden');
          checkHiddenUnlock();
      }

      gameOverOverlay.classList.remove('hidden');
  }

  // --- ë­í‚¹ ì‹œìŠ¤í…œ ---
  function openRanking() { gameOverOverlay.classList.add('hidden'); rankingOverlay.classList.remove('hidden'); loadRank(); }
  function closeRanking() { rankingOverlay.classList.add('hidden'); gameOverOverlay.classList.remove('hidden'); }
  
  function submitRank() {
      const name = nicknameInput.value.trim() || "ìµëª…";
      if (!confirm(`${name}ë‹˜ ${Math.floor(score)}ì ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      
      fetch(SCRIPT_URL, {
          method: 'POST', mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name, score: Math.floor(score) })
      }).then(() => { alert("ë“±ë¡ ì™„ë£Œ!"); loadRank(); });
  }

  function loadRank() {
      rankList.innerHTML = "ë¡œë”© ì¤‘...";
      fetch(SCRIPT_URL).then(res => res.json()).then(data => {
          let html = "";
          data.slice(0, 10).forEach((item, idx) => {
              let rankIcon = idx === 0 ? "ğŸ¥‡" : (idx === 1 ? "ğŸ¥ˆ" : (idx === 2 ? "ğŸ¥‰" : `${idx+1}ìœ„`));
              html += `<div class="rank-item"><span>${rankIcon} ${item.name}</span><span>${item.score}</span></div>`;
          });
          rankList.innerHTML = html;
      }).catch(() => rankList.innerHTML = "ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨");
  }

  function shareScore() {
    const text = `ğŸƒ Dopamine Runner\n[ê¸°ë¡] ${Math.floor(score)}ì \në„ì „í•´ë³´ì„¸ìš”! ğŸ‘‡\nğŸ”— ${window.location.href}`;
    if (navigator.share) { navigator.share({ title: 'Dopamine Runner', text: text, url: window.location.href }).catch(console.error); }
    else { navigator.clipboard.writeText(text).then(() => alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!")); }
  }

  window.addEventListener('keydown', (e) => { if (e.code === 'Space') { if(!isRunning) { if(!startOverlay.classList.contains('hidden')) startGame(); else if(!gameOverOverlay.classList.contains('hidden')) restartGame(); } else jump(); } });
  stage.addEventListener('touchstart', (e) => { if(e.target.closest('button') || e.target.closest('.chip')) return; e.preventDefault(); if(!isRunning) { if(!startOverlay.classList.contains('hidden')) startGame(); else if(!gameOverOverlay.classList.contains('hidden')) restartGame(); } else jump(); }, {passive:false});
  stage.addEventListener('mousedown', (e) => { if(e.target.closest('button') || e.target.closest('.chip')) return; if(isRunning) jump(); });

</script>
</body>
</html>